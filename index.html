<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Chat An√≥nimo Cifrado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #5b7c99;
            --primary-dark: #4a6785;
            --bg-light: #f5f7fa;
            --bg-white: #ffffff;
            --bg-chat: #eef2f7;
            --text-primary: #2c3e50;
            --text-secondary: #6c7a89;
            --border: #dce1e8;
            --message-sent: #d4e3f3;
            --message-received: #ffffff;
            --hover: #f8f9fb;
            --active: #e8ecf1;
            --online: #00ff88;
            --success: #00d9b3;
            --danger: #ff4757;
        }
        
        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-white);
        }
        
        /* Sidebar */
        .sidebar {
            width: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            background: var(--bg-white);
        }
        
        .sidebar-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .header-icons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-header {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-header:active {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .connection-status {
            font-size: 1.5rem;
        }
        
        .tabs {
            display: flex;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .tab {
            flex: 1;
            padding: 0.875rem 0.5rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--active);
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .contacts-list {
            background: var(--bg-white);
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
            position: relative;
        }
        
        .contact-item:active {
            background: var(--hover);
        }
        
        .contact-item.active {
            background: var(--active);
        }
        
        .contact-avatar-wrapper {
            position: relative;
            margin-right: 0.875rem;
            flex-shrink: 0;
        }
        
        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.125rem;
            font-weight: 600;
            overflow: hidden;
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid var(--bg-white);
        }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.25rem;
        }
        
        .contact-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .contact-time {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }
        
        .contact-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .contact-message.unread {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 0.125rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .add-contact-section, .profile-section {
            padding: 1.5rem 1.25rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }
        
        .info-card {
            background: var(--bg-light);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .code-display {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            word-break: break-all;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 2px solid var(--primary);
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }
        
        .code-text {
            color: var(--primary);
            font-weight: 600;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.2);
        }
        
        .btn-copy:active {
            transform: scale(0.98);
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-white);
            min-height: 52px;
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(91, 124, 153, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        .btn-add {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 52px;
            box-shadow: 0 4px 12px rgba(91, 124, 153, 0.2);
        }
        
        .btn-add:active {
            transform: scale(0.98);
        }
        
        .profile-photo-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .profile-photo-wrapper {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            position: relative;
        }
        
        .profile-photo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: 600;
            overflow: hidden;
            border: 4px solid var(--bg-light);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn-change-photo {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--bg-white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .settings-section {
            padding: 1.25rem 1rem;
        }
        
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .setting-label {
            font-size: 0.9375rem;
            color: var(--text-primary);
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            background: var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--primary);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        
        .toggle-switch.active::after {
            left: 22px;
        }
        
        /* Chat Panel */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
        }
        
        .chat-header {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            min-height: 56px;
            border-bottom: 1px solid var(--primary-dark);
            flex-shrink: 0;
        }
        
        .btn-back {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
            display: none;
        }
        
        .chat-avatar-wrapper {
            position: relative;
            margin-right: 0.75rem;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: 600;
            overflow: hidden;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-info h2 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }
        
        .chat-status {
            font-size: 0.75rem;
            opacity: 0.85;
        }
        
        /* ‚úÖ SCROLL EN MENSAJES */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 0.5rem;
            display: flex;
            animation: fadeInMessage 0.25s ease;
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message-bubble {
            padding: 0.625rem 0.875rem 0.75rem;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            max-width: 100%;
        }
        
        .message.sent .message-bubble {
            background: var(--message-sent);
            border-bottom-right-radius: 4px;
        }
        
        .message.received .message-bubble {
            background: var(--message-received);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .message-text {
            font-size: 0.9375rem;
            line-height: 1.4;
            color: var(--text-primary);
            word-wrap: break-word;
            margin-bottom: 0.25rem;
        }
        
        .message-image {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.25rem;
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.25rem;
        }
        
        .message-time {
            font-size: 0.6875rem;
            color: var(--text-secondary);
        }
        
        .message-status {
            font-size: 0.875rem;
            color: var(--primary);
            margin-left: 0.25rem;
        }
        
        .view-once-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }
        
        /* ‚úÖ INPUT FIJO ABAJO EN M√ìVIL */
        .chat-input-area {
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            padding: 0.75rem 1rem;
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
        }
        
        .image-preview-container {
            display: none;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        
        .image-preview-container.active {
            display: block;
        }
        
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        
        .preview-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-preview {
            flex: 1;
            min-width: 100px;
            padding: 0.625rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.8125rem;
        }
        
        .btn-preview-cancel {
            background: var(--border);
            color: var(--text-primary);
        }
        
        .btn-preview-view-once {
            background: var(--danger);
            color: white;
        }
        
        .btn-preview-send {
            background: var(--primary);
            color: white;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .btn-input-action {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .btn-input-action:active {
            background: var(--hover);
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-light);
            resize: none;
            max-height: 120px;
            min-height: 44px;
            transition: all 0.2s;
        }
        
        .chat-input:focus {
            outline: none;
            background: var(--bg-white);
            border-color: var(--primary);
        }
        
        .btn-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .btn-send:active {
            background: var(--primary-dark);
            transform: scale(0.95);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .image-viewer {
            background: rgba(0, 0, 0, 0.95);
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        .notification {
            position: fixed;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.3s ease;
            z-index: 1000;
            font-size: 0.9375rem;
            text-align: center;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.4;
        }
        
        .hidden {
            display: none !important;
        }
        
        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #909090;
        }

        /* ‚úÖ ESTILOS M√ìVIL */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
            }
            
            .sidebar.hidden-mobile {
                display: none;
            }
            
            .chat-panel {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 101;
                display: none;
            }
            
            .chat-panel.active-mobile {
                display: flex;
            }
            
            .btn-back {
                display: flex;
            }
        }

        /* ‚úÖ ESTILOS DESKTOP */
        @media (min-width: 768px) {
            .app-container {
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.08);
            }

            .sidebar {
                width: 380px;
            }

            .contact-item:hover {
                background: var(--hover);
            }

            .btn-header:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .btn-input-action:hover {
                background: var(--hover);
            }

            .btn-send:hover {
                background: var(--primary-dark);
                transform: scale(1.05);
            }

            .message {
                max-width: 65%;
            }

            .notification {
                left: auto;
                right: 1.5rem;
                bottom: auto;
                top: 1.5rem;
                max-width: 400px;
            }

            .code-display {
                flex-direction: row;
                align-items: center;
            }

            @keyframes slideUp {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">üîê Chat Cifrado</h1>
                <div class="header-icons">
                    <div class="connection-status" id="connectionStatus">‚óè</div>
                    <button class="btn-header" onclick="app.openSettings()" title="Ajustes">‚öôÔ∏è</button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="app.switchTab('chats')">Chats</button>
                <button class="tab" onclick="app.switchTab('add')">A√±adir</button>
                <button class="tab" onclick="app.switchTab('profile')">Mi C√≥digo</button>
            </div>
            
            <div class="tab-content active" id="tab-chats">
                <div class="contacts-list" id="contactsList"></div>
            </div>
            
            <div class="tab-content" id="tab-add">
                <div class="add-contact-section">
                    <h2 class="section-title">A√±adir Contacto</h2>
                    
                    <div class="form-group">
                        <label class="form-label">C√≥digo del contacto</label>
                        <input type="text" class="form-input" id="contactIdInput" placeholder="user_abc123...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre del contacto</label>
                        <input type="text" class="form-input" id="contactNameInput" placeholder="Juan, Mar√≠a...">
                    </div>
                    
                    <button class="btn-add" onclick="app.addContact()">Agregar Contacto</button>
                </div>
            </div>
            
            <div class="tab-content" id="tab-profile">
                <div class="profile-section">
                    <h2 class="section-title">Mi Perfil</h2>
                    
                    <div class="profile-photo-section">
                        <div class="profile-photo-wrapper">
                            <div class="profile-photo" id="myProfilePhoto"></div>
                            <button class="btn-change-photo" onclick="app.changeProfilePhoto()">üì∑</button>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Tu c√≥digo √∫nico</div>
                        <div class="code-display">
                            <span class="code-text" id="myUserId"></span>
                        </div>
                        <button class="btn-copy" onclick="app.copyUserId()">üìã Copiar C√≥digo</button>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; text-align: center;">
                        Comparte tu c√≥digo para que puedan agregarte
                    </p>
                </div>
            </div>
        </div>
        
        <div class="chat-panel" id="chatPanel">
            <div id="emptyChatState" class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <h3>Chat An√≥nimo Cifrado</h3>
                <p>Selecciona un contacto para comenzar a chatear</p>
            </div>
            
            <div id="activeChatArea" class="hidden">
                <div class="chat-header">
                    <button class="btn-back" onclick="app.backToContacts()">‚Üê</button>
                    <div class="chat-avatar-wrapper">
                        <div class="chat-avatar" id="chatAvatar"></div>
                        <div class="online-indicator hidden" id="chatOnlineIndicator"></div>
                    </div>
                    <div class="chat-info">
                        <h2 id="chatContactName">Contacto</h2>
                        <div class="chat-status" id="chatStatus">üîí Cifrado end-to-end</div>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer"></div>
                
                <div class="chat-input-area">
                    <div class="image-preview-container" id="imagePreviewContainer">
                        <img id="imagePreview" class="image-preview" src="" alt="Vista previa">
                        <div class="preview-options">
                            <button class="btn-preview btn-preview-cancel" onclick="app.cancelImagePreview()">Cancelar</button>
                            <button class="btn-preview btn-preview-view-once" onclick="app.sendImageViewOnce()">üëÅÔ∏è Ver 1x</button>
                            <button class="btn-preview btn-preview-send" onclick="app.sendImageNormal()">üì§ Enviar</button>
                        </div>
                    </div>
                    
                    <div class="chat-input-wrapper">
                        <button class="btn-input-action" onclick="app.attachImage()" title="Enviar imagen">üì∑</button>
                        <textarea class="chat-input" id="messageInput" placeholder="Escribe un mensaje" rows="1"></textarea>
                        <button class="btn-send" onclick="app.sendMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Ajustes</h2>
                <button class="btn-close" onclick="app.closeSettings()">‚úï</button>
            </div>
            
            <div class="settings-group">
                <h3>Notificaciones</h3>
                <div class="setting-item">
                    <span class="setting-label">Activar notificaciones</span>
                    <div class="toggle-switch" id="toggleNotifications" onclick="app.toggleNotifications()"></div>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Privacidad</h3>
                <div class="setting-item">
                    <span class="setting-label">Mostrar estado online</span>
                    <div class="toggle-switch" id="toggleOnlineStatus" onclick="app.toggleOnlineStatus()"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Confirmar lectura de mensajes</span>
                    <div class="toggle-switch active" id="toggleReadReceipts" onclick="app.toggleReadReceipts()"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay image-viewer" id="imageViewer" onclick="app.closeImageViewer()">
        <img id="viewerImage" src="" alt="">
    </div>

    <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" onchange="app.handleImageSelect(event)">
    <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="app.handleProfilePhotoSelect(event)">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCHlsKq3TDIfQHdZl2ALWJ_ctf0D7n_7jE",
            authDomain: "chatanoci.firebaseapp.com",
            databaseURL: "https://chatanoci-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chatanoci",
            storageBucket: "chatanoci.firebasestorage.app",
            messagingSenderId: "832507950926",
            appId: "1:832507950926:web:5c9926e3914a7c54f2101f"
        };

        let database = null;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            useFirebase = true;
            document.getElementById('connectionStatus').style.color = '#00ff88';
        } catch (e) {
            document.getElementById('connectionStatus').style.color = '#ff4757';
        }

        class ChatApp {
            constructor() {
                this.userId = null;
                this.contacts = [];
                this.activeContact = null;
                this.activeTab = 'chats';
                this.isMobile = window.innerWidth < 768;
                this.settings = {
                    notifications: true,
                    onlineStatus: true,
                    readReceipts: true
                };
                this.onlineUsers = new Set();
                this.typingUsers = new Set();
                this.pendingImage = null;
                
                this.init();
                
                window.addEventListener('resize', () => {
                    const prev = this.isMobile;
                    this.isMobile = window.innerWidth < 768;
                    if (prev !== this.isMobile) this.updateLayout();
                });
            }

            async init() {
                await this.loadOrCreateIdentity();
                this.loadContacts();
                this.loadSettings();
                this.requestNotificationPermissionOnce();
                this.renderContacts();
                this.setupEventListeners();
                
                if (useFirebase) {
                    this.setupFirebaseListeners();
                    this.updateOnlineStatus(true);
                }

                setInterval(() => {
                    if (useFirebase && this.settings.onlineStatus) {
                        this.updateOnlineStatus(true);
                    }
                }, 30000);
            }

            generateUserId() {
                return 'user_' + Array.from(crypto.getRandomValues(new Uint8Array(16)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            async loadOrCreateIdentity() {
                const KEY = 'chatapp_main_identity';
                const saved = this.loadFromStorage(KEY);

                if (!saved) {
                    this.userId = this.generateUserId();
                    this.saveToStorage(KEY, { userId: this.userId, profilePhoto: null });
                    document.getElementById('myProfilePhoto').textContent = this.userId.charAt(5).toUpperCase();
                } else {
                    this.userId = saved.userId;
                    if (saved.profilePhoto) {
                        document.getElementById('myProfilePhoto').innerHTML = `<img src="${saved.profilePhoto}" alt="Perfil">`;
                    } else {
                        document.getElementById('myProfilePhoto').textContent = this.userId.charAt(5).toUpperCase();
                    }
                }

                document.getElementById('myUserId').textContent = this.userId;
            }

            loadSettings() {
                const saved = this.loadFromStorage(`settings_${this.userId}`);
                if (saved) {
                    this.settings = saved;
                    if (this.settings.notifications) {
                        document.getElementById('toggleNotifications').classList.add('active');
                    }
                    if (this.settings.onlineStatus) {
                        document.getElementById('toggleOnlineStatus').classList.add('active');
                    }
                    if (this.settings.readReceipts) {
                        document.getElementById('toggleReadReceipts').classList.add('active');
                    }
                }
            }

            saveSettings() {
                this.saveToStorage(`settings_${this.userId}`, this.settings);
            }

            saveToStorage(k, d) {
                localStorage.setItem(k, JSON.stringify(d));
            }

            loadFromStorage(k) {
                const data = localStorage.getItem(k);
                return data ? JSON.parse(data) : null;
            }

            loadContacts() {
                this.contacts = this.loadFromStorage(`contacts_${this.userId}`) || [];
            }

            saveContacts() {
                this.saveToStorage(`contacts_${this.userId}`, this.contacts);
            }

            requestNotificationPermissionOnce() {
                const KEY = 'notification_permission_requested';
                
                if (!localStorage.getItem(KEY)) {
                    if ('Notification' in window && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                    localStorage.setItem(KEY, 'true');
                }
            }

            showSystemNotification(title, body) {
                if ('Notification' in window && Notification.permission === 'granted' && this.settings.notifications) {
                    new Notification(title, { body, icon: '/icon.png' });
                }
            }

            setupFirebaseListeners() {
                database.ref(`messages/${this.userId}`).on('child_added', snap => {
                    const msg = snap.val();
                    snap.ref.remove();
                    this.handleIncomingMessage(msg);
                });

                database.ref('online').on('value', snap => {
                    const online = snap.val() || {};
                    this.onlineUsers = new Set(Object.keys(online));
                    this.renderContacts();
                    if (this.activeContact) {
                        this.updateChatStatus();
                    }
                });

                database.ref('typing').on('value', snap => {
                    const typing = snap.val() || {};
                    this.typingUsers = new Set(Object.keys(typing).filter(key => typing[key]));
                    if (this.activeContact && typing[this.activeContact.id]) {
                        document.getElementById('chatStatus').textContent = 'Escribiendo...';
                    } else if (this.activeContact) {
                        this.updateChatStatus();
                    }
                });
            }

            updateOnlineStatus(isOnline) {
                if (!useFirebase) return;
                
                if (isOnline) {
                    database.ref(`online/${this.userId}`).set(Date.now());
                    database.ref(`online/${this.userId}`).onDisconnect().remove();
                } else {
                    database.ref(`online/${this.userId}`).remove();
                }
            }

            setTypingStatus(isTyping) {
                if (!useFirebase || !this.activeContact) return;
                
                if (isTyping) {
                    database.ref(`typing/${this.userId}`).set(this.activeContact.id);
                } else {
                    database.ref(`typing/${this.userId}`).remove();
                }
            }

            updateChatStatus() {
                if (!this.activeContact) return;
                
                const statusEl = document.getElementById('chatStatus');
                const indicatorEl = document.getElementById('chatOnlineIndicator');
                
                if (this.onlineUsers.has(this.activeContact.id)) {
                    statusEl.textContent = 'En l√≠nea';
                    indicatorEl.classList.remove('hidden');
                } else {
                    const lastSeen = this.activeContact.lastSeen;
                    if (lastSeen) {
                        const date = new Date(lastSeen);
                        const now = new Date();
                        const diff = now - date;
                        
                        if (diff < 60000) {
                            statusEl.textContent = 'Hace un momento';
                        } else if (diff < 3600000) {
                            statusEl.textContent = `Hace ${Math.floor(diff / 60000)} min`;
                        } else if (date.toDateString() === now.toDateString()) {
                            statusEl.textContent = `Hoy a las ${date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}`;
                        } else {
                            statusEl.textContent = `${date.toLocaleDateString('es', { day: '2-digit', month: '2-digit' })}`;
                        }
                    } else {
                        statusEl.textContent = 'üîí Cifrado end-to-end';
                    }
                    indicatorEl.classList.add('hidden');
                }
            }

            handleIncomingMessage(msg) {
                const contact = this.contacts.find(c => c.id === msg.from);
                
                if (!contact || contact.blocked) return;

                if (!contact.messages.find(m => m.id === msg.id)) {
                    contact.messages.push(msg);
                    contact.lastSeen = Date.now();

                    if (this.activeContact?.id !== contact.id) {
                        contact.unreadCount = (contact.unreadCount || 0) + 1;
                        this.showSystemNotification(contact.name, msg.text || 'üì∑ Imagen');
                    } else {
                        if (this.settings.readReceipts && useFirebase) {
                            database.ref(`read/${msg.from}/${msg.id}`).set(true);
                        }
                    }

                    this.saveContacts();
                    this.renderContacts();
                    
                    if (this.activeContact?.id === contact.id) {
                        this.renderMessages();
                    }
                }
            }

            addContact() {
                const id = document.getElementById('contactIdInput').value.trim();
                const name = document.getElementById('contactNameInput').value.trim();

                if (!id || !name) {
                    this.showNotification('Completa ambos campos');
                    return;
                }

                if (id === this.userId) {
                    this.showNotification('No puedes agregarte a ti mismo');
                    return;
                }

                if (this.contacts.find(c => c.id === id)) {
                    this.showNotification('Este contacto ya existe');
                    return;
                }

                this.contacts.push({
                    id,
                    name,
                    messages: [],
                    unreadCount: 0,
                    blocked: false,
                    muted: false,
                    profilePhoto: null,
                    lastSeen: null
                });

                this.saveContacts();
                this.renderContacts();
                this.switchTabProgrammatically('chats');
                
                document.getElementById('contactIdInput').value = '';
                document.getElementById('contactNameInput').value = '';
                
                this.showNotification('Contacto agregado');
            }

            renderContacts() {
                const container = document.getElementById('contactsList');
                
                if (this.contacts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No tienes contactos</p></div>';
                    return;
                }

                container.innerHTML = this.contacts.map(contact => {
                    const isOnline = this.onlineUsers.has(contact.id);
                    const hasUnread = contact.unreadCount > 0;
                    
                    return `
                        <div class="contact-item ${this.activeContact?.id === contact.id ? 'active' : ''}" 
                             onclick="app.selectContact('${contact.id}')">
                            <div class="contact-avatar-wrapper">
                                <div class="contact-avatar">
                                    ${contact.profilePhoto ? `<img src="${contact.profilePhoto}" alt="${contact.name}">` : contact.name.charAt(0).toUpperCase()}
                                </div>
                                ${isOnline ? '<div class="online-indicator"></div>' : ''}
                            </div>
                            <div class="contact-info">
                                <div class="contact-header">
                                    <div class="contact-name">${this.escapeHtml(contact.name)}</div>
                                    ${hasUnread ? `<span class="unread-badge">${contact.unreadCount}</span>` : ''}
                                </div>
                                <div class="contact-message ${hasUnread ? 'unread' : ''}">
                                    ${contact.blocked ? 'üö´ Bloqueado' : contact.muted ? 'üîï Silenciado' : this.getLastMessagePreview(contact)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getLastMessagePreview(contact) {
                if (!contact.messages || contact.messages.length === 0) {
                    return 'Sin mensajes';
                }
                
                const lastMsg = contact.messages[contact.messages.length - 1];
                const prefix = lastMsg.from === this.userId ? 'T√∫: ' : '';
                
                if (lastMsg.image) return prefix + 'üì∑ Imagen';
                
                return prefix + (lastMsg.text?.substring(0, 30) || '') + (lastMsg.text?.length > 30 ? '...' : '');
            }

            selectContact(id) {
                this.activeContact = this.contacts.find(c => c.id === id);
                if (!this.activeContact) return;

                this.activeContact.unreadCount = 0;
                this.saveContacts();

                // ‚úÖ SOLO EN M√ìVIL: ocultar sidebar
                if (this.isMobile) {
                    document.getElementById('sidebar').classList.add('hidden-mobile');
                    document.getElementById('chatPanel').classList.add('active-mobile');
                }

                document.getElementById('emptyChatState').classList.add('hidden');
                document.getElementById('activeChatArea').classList.remove('hidden');
                
                const avatar = document.getElementById('chatAvatar');
                if (this.activeContact.profilePhoto) {
                    avatar.innerHTML = `<img src="${this.activeContact.profilePhoto}" alt="${this.activeContact.name}">`;
                } else {
                    avatar.textContent = this.activeContact.name.charAt(0).toUpperCase();
                }
                
                document.getElementById('chatContactName').textContent = this.activeContact.name;
                this.updateChatStatus();
                this.renderMessages();
                this.renderContacts();

                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 100);
            }

            backToContacts() {
                if (this.isMobile) {
                    document.getElementById('sidebar').classList.remove('hidden-mobile');
                    document.getElementById('chatPanel').classList.remove('active-mobile');
                }
                this.setTypingStatus(false);
            }

            updateLayout() {
                if (!this.isMobile) {
                    document.getElementById('sidebar').classList.remove('hidden-mobile');
                    document.getElementById('chatPanel').classList.remove('active-mobile');
                }
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text || !this.activeContact) return;

                const msg = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    from: this.userId,
                    to: this.activeContact.id,
                    text,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                this.activeContact.messages.push(msg);
                this.saveContacts();
                this.renderMessages();
                this.renderContacts();
                
                input.value = '';
                input.style.height = 'auto';
                this.setTypingStatus(false);

                if (useFirebase) {
                    database.ref(`messages/${msg.to}`).push(msg);
                }
            }

            renderMessages() {
                if (!this.activeContact) return;

                const container = document.getElementById('messagesContainer');

                if (this.activeContact.messages.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="font-size: 0.875rem;">Los mensajes est√°n cifrados end-to-end</p></div>';
                    return;
                }

                container.innerHTML = this.activeContact.messages.map(msg => {
                    const isSent = msg.from === this.userId;
                    const time = new Date(msg.timestamp).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });

                    let content = '';
                    
                    if (msg.image) {
                        content = `<img src="${msg.image}" class="message-image" onclick="app.viewImage('${msg.image}')" alt="Imagen">`;
                        if (msg.viewOnce) {
                            content += '<span class="view-once-badge">VER UNA VEZ</span>';
                        }
                    } else {
                        content = `<div class="message-text">${this.escapeHtml(msg.text)}</div>`;
                    }

                    const status = isSent ? (msg.read ? '‚úì‚úì' : '‚úì') : '';

                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble">
                                ${content}
                                <div class="message-footer">
                                    <span class="message-time">${time}</span>
                                    ${status ? `<span class="message-status">${status}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.scrollTop = container.scrollHeight;
            }

            attachImage() {
                document.getElementById('imageInput').click();
            }

            handleImageSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.pendingImage = e.target.result;
                    document.getElementById('imagePreview').src = this.pendingImage;
                    document.getElementById('imagePreviewContainer').classList.add('active');
                };
                
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            cancelImagePreview() {
                this.pendingImage = null;
                document.getElementById('imagePreviewContainer').classList.remove('active');
            }

            sendImageViewOnce() {
                this.sendImageMessage(true);
            }

            sendImageNormal() {
                this.sendImageMessage(false);
            }

            sendImageMessage(viewOnce) {
                if (!this.pendingImage || !this.activeContact) return;

                const msg = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    from: this.userId,
                    to: this.activeContact.id,
                    image: this.pendingImage,
                    timestamp: new Date().toISOString(),
                    read: false,
                    viewOnce: viewOnce
                };

                this.activeContact.messages.push(msg);
                this.saveContacts();
                this.renderMessages();
                this.renderContacts();

                if (useFirebase) {
                    database.ref(`messages/${msg.to}`).push(msg);
                }

                this.cancelImagePreview();
            }

            viewImage(src) {
                document.getElementById('viewerImage').src = src;
                document.getElementById('imageViewer').classList.add('active');
            }

            closeImageViewer() {
                document.getElementById('imageViewer').classList.remove('active');
            }

            changeProfilePhoto() {
                document.getElementById('profilePhotoInput').click();
            }

            handleProfilePhotoSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoData = e.target.result;
                    document.getElementById('myProfilePhoto').innerHTML = `<img src="${photoData}" alt="Perfil">`;
                    
                    const identity = this.loadFromStorage('chatapp_main_identity');
                    identity.profilePhoto = photoData;
                    this.saveToStorage('chatapp_main_identity', identity);
                    
                    if (useFirebase) {
                        database.ref(`profiles/${this.userId}`).set({ photo: photoData });
                    }
                };
                
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            openSettings() {
                document.getElementById('settingsModal').classList.add('active');
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            toggleNotifications() {
                this.settings.notifications = !this.settings.notifications;
                document.getElementById('toggleNotifications').classList.toggle('active');
                this.saveSettings();
            }

            toggleOnlineStatus() {
                this.settings.onlineStatus = !this.settings.onlineStatus;
                document.getElementById('toggleOnlineStatus').classList.toggle('active');
                this.saveSettings();
                
                if (useFirebase) {
                    this.updateOnlineStatus(this.settings.onlineStatus);
                }
            }

            toggleReadReceipts() {
                this.settings.readReceipts = !this.settings.readReceipts;
                document.getElementById('toggleReadReceipts').classList.toggle('active');
                this.saveSettings();
            }

            copyUserId() {
                const userId = document.getElementById('myUserId').textContent;
                navigator.clipboard.writeText(userId).then(() => {
                    this.showNotification('C√≥digo copiado');
                }).catch(() => {
                    this.showNotification('Error al copiar');
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showNotification(msg) {
                const n = document.createElement('div');
                n.className = 'notification';
                n.textContent = msg;
                document.body.appendChild(n);
                setTimeout(() => n.remove(), 2500);
            }

            switchTab(tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
                this.activeTab = tab;
            }

            switchTabProgrammatically(tab) {
                document.querySelectorAll('.tab, .tab-content').forEach(e => e.classList.remove('active'));
                const tabs = document.querySelectorAll('.tab');
                if (tab === 'chats') tabs[0].classList.add('active');
                else if (tab === 'add') tabs[1].classList.add('active');
                else if (tab === 'profile') tabs[2].classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
            }

            setupEventListeners() {
                const input = document.getElementById('messageInput');
                
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                input.addEventListener('input', e => {
                    e.target.style.height = 'auto';
                    e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
                    
                    if (e.target.value.trim()) {
                        this.setTypingStatus(true);
                    } else {
                        this.setTypingStatus(false);
                    }
                });

                input.addEventListener('blur', () => {
                    setTimeout(() => this.setTypingStatus(false), 1000);
                });
            }
        }

        const app = new ChatApp();
    </script>
</body>
</html>
